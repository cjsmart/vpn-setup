---
- name: Ensure iptables is installed
  ansible.builtin.apt:
    name: iptables
    state: present

- name: Ensure iptables-persistent is installed
  ansible.builtin.apt:
    name: iptables-persistent
    state: present

- name: Allow DNS (port 53) on tun0 interface
  ansible.builtin.iptables:
    chain: INPUT
    in_interface: tun0
    protocol: udp
    destination_port: 53
    jump: ACCEPT
    comment: "Allow DNS for Pi-hole on tun0"
  register: allow_dns_tun0

- name: Drop DNS (port 53) on other interfaces
  ansible.builtin.iptables:
    chain: INPUT
    protocol: udp
    destination_port: 53
    jump: DROP
    comment: "Drop DNS for Pi-hole on other interfaces"
  register: drop_dns_other

- name: Save iptables rules
  ansible.builtin.shell: iptables-save > /etc/iptables/rules.v4
  args:
    creates: /etc/iptables/rules.v4
  when: allow_dns_tun0 is changed or drop_dns_other is changed

- name: Ensure iptables rules are loaded on boot
  ansible.builtin.copy:
    dest: /etc/network/if-pre-up.d/iptables
    content: |
      #!/bin/sh
      /sbin/iptables-restore < /etc/iptables/rules.v4
    mode: '0755'
  when: allow_dns_tun0 is changed or drop_dns_other is changed
