# vpn-setup
ansible playbook для установки и настройки vpn и связанных сервисов на чистой виртуалке

## Запуск
1. Убеждаемся, что на удалённой машине есть доступ через публичный ключ. Чаще всего на чистой машине есть пользователь `root` с нужным ключом в `/root/.ssh/authorized_keys`. 
   Можно использовать и другого пользователя с sudo-правами, главное также чтобы у нас был доступ по публичному ключу, это требуется для запуска ansible-плейбуков.
2. Выполняем первичную настройку, добавим нового пользователя, под которым будем запускать основной плейбук:
   ```bash
   ansible-playbook --user <пользователь> -i <ip-адрес-машины>, bootstrap.yml
   ```
   Запятая тут обязательна, чтобы ansible взял адрес из командной строки, а не из inventories
3. Запускаем основной плейбук:
   ```bash
   ansible-playbook -i <ip-адрес-машины> playbook.yml
   ```

Оба плейбука можно выполнить вместе одним скриптом:
```bash
chmod +x run.sh
./run.sh -u <пользователь> -h <ip-адрес-машины>
```

## Что настраиваем
bootstrap.yml:
1. Добавляем нового пользователя `vpn` и дайм ему sudo-права
2. Добавляем локальные публичные ключи из `~/.ssh/*.pub` в authorized_keys для пользователя `vpn`

playbook.yml:
1. Ставим OpenVPN
2. Ставим pi-hole
3. Настраиваем OpenVPN на использование pi-hole в качестве DNS-сервера
4. Запрещаем доступ к pihole (и DNS, и HTTP) извне OpenVPN-сети
5. Ставим fail2ban и настраиваем на работу с ssh
6. Настраиваем iptables на блокировку любых подключений, кроме ssh и OpenVPN
